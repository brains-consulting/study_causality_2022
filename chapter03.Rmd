---
title: |
  | 統計的因果推論の理論と実装
  |
  | Chapter3
  | 統計的因果推論における重要な仮定
  |
  |
author: "大隈 亮"
date: '2022-03-25 (Fri)'
output: 
  revealjs::revealjs_presentation:
    #self_contained: false
    transition: none
    highlight: pygments
    theme: white
    reveal_options:
      #autoSlide: 5000
      width: 1280
      height: 960
      control: true
    css: "for-revealjs.css"
    pandoc_args: [
      '--from', 'markdown+autolink_bare_uris+tex_math_single_backslash-implicit_figures'
      ]
editor_options: 
  markdown: 
    wrap: 72
---

# Index

## Index {#index_1}

-   Chapter3の目的

-   3.1 SUTVA

-   3.2 確率

-   3.3 条件付き確率と独立性

-   3.4 条件付き期待値

-   3.5 識別性の条件

-   3.6 実験研究における平均処置効果（ATE）の推定

-   3.7 独立性と条件付独立性：シンプソンのパラドックス

-   3.8 共変量の役割

-   3.9 回帰分析と共分散分析

# Chapter3の目的

## Chapter3の目的 {#ch3_1}

第2章では、

**処置の無作為割付けによって平均処置効果（ATE）を適切に推定可能**

であることを具体的に確認した

<br />

～2章の軽いおさらい～

処置効果の種類：

1.  個体処置効果（ITE: individual treatment effect）
2.  平均処置効果（ATE: average treatment effect）
3.  処置群における平均処置効果（ATT: average treatment effect for the treated）

<br /> - 個体処置効果（ITE）を知ることが因果推論の究極的な目的である

-   個体処置効果は定義できても観測も推定もできない（**因果推論の根本問題**）

    -   個体の集まりである、母集団における平均処置効果（ATE）を考える

-   一般的に、因果効果を図る推定対象は、平均処置効果（ATE）または、処置群における平均処置効果（ATT）である

-   処置群と統制群に無作為割付けできれば、平均処置効果（ATE）を適切に推定可能

------------------------------------------------------------------------

## Chapter3の目的

第3章では、以下を目的とする

-   無作為割付けを行うことで、統計的因果推論が可能になる理由の確認（ややフォーマルに）

-   統計的因果推論におけるいくつかの重要な仮定についての具体的な検討

-   上記を踏まえたうえで、無作為割付けを実行できない観察研究における統計的因果推論に <br />ついての議論

# 3.1 SUTVA

## 3.1 SUTVA {#SEC3_1_1}

SUTVA : Stable Unit Treatment Value Assumption

処置を受ける個体（unit）ごとに処置の値が安定的という仮定

<br/> <br/> 以下の2つの条件から成り立つ（Imbens and Rubin, 2015, pp.10-12）

-   条件1：相互干渉がない（no interference）
-   条件2：個体に対する隠れた処置がない（no hidden variation of treatments）

------------------------------------------------------------------------

### 条件1：相互干渉がない（no interference）

**個体Aに対しての処置が、別の個体Bに対して影響を及ぼさないという意味**

<br/> <u>例1：薬と病気の関係</u>

AさんとBさんは、どちらも今、頭痛がしている

-   Aさん：頭痛を緩和するためにアスピリンを飲んだ
-   Bさん：アスピリンを飲んでいない

<br/> このとき、Bさんはアスピリンを飲んでいないにもかかわらず、

**Aさんの飲んだアスピリンの効果でBさんの頭痛が緩和される**

のであれば、相互干渉があるということであるが、

現実にはこのようなことはなさそうである

------------------------------------------------------------------------

<u>例2：予防接種と病気の関係</u>

AさんとBさんは、どちらも今、インフルエンザに罹っていない

-   Aさん：インフルエンザの予防接種を受けている
-   Bさん：インフルエンザの予防接種を受けていない
-   AさんとBさんは一緒に生活をしている

<br/> Bさんは予防接種を受けていないにもかかわらず、

**Aさんが予防接種を受けてインフルエンザに罹りにくくなったおかげで、Bさんのインフルエンザに罹る確率も下がる**

と考えられそうである

<br /> つまり、この場合は**相互干渉がある**ということである

------------------------------------------------------------------------

### 条件1が満たされないとき

これらの例のように、「条件1：相互干渉がない」が満たされない場合には、

**相互干渉のある集団を1つの個体として扱う**ことで、条件を満たすことができる <br /> （Imbens and Robin, 2015, p11; 岩崎, 2015, pp.78-79）

<br /> 同じ家に住む人、同じ地域に住む人、同じ学校に通う人を1つの個体として扱う

つまり、

**分析の単位を個人ではなく、世帯、市区町村、学校などの集団に変更する**

ということである

------------------------------------------------------------------------

### 条件2：個体に対する隠れた処置がない（no hidden variation of treatments）

**ある処置を受ける個体が、その処置を別の形で受けてはいけないという意味**

<br/> <u>例：補習授業の効果</u>

数学の補習授業であれば、補習授業を受けるすべての学生は、

同じ教材・同じ方法で教わらなければならないということである

<br /> 補習授業が1クラスであれば、この仮定は容易に満たされるが、

2クラスある場合、教材は同じにできるであろうが、異なる教員が担当した場合、

その違いが問題になるかもしれない

------------------------------------------------------------------------

### 条件2が満たされないとき

例のように、「条件2：個体に対する隠れた処置がない」が満たされない場合には、

**処置のレベルを再定義する**ことで、この条件を満たすことができる <br /> （Imbens and Rubin, 2015, p.12）

<br /> たとえば、「補習授業受けた」か「受けていない」ではなく、

-   A先生の補習授業を受けた
-   B先生の補習授業を受けた
-   補習授業を受けていない

の3つに分けて考えるといった具合である

------------------------------------------------------------------------

### SUTVAとは

SUTVAは、**本質的に除外制約（exclusion restriction）である**

<br/> つまり、

**ある処置と比較して、別の処置の因果効果の存在を除外するために、**

**外的な情報や背景知識に依拠するという仮定**

である <br /> （Imbens and Rubin, 2015, p.10）

<br/> 第1章において議論した、操作なくして因果なしの原則は、SUTVAを満たすための重要な考え方である <br /> （Rubin, 1986, p.962）

<br /> なぜならば、操作なくして因果なしの原則を通して、何が処置であるのか、何が効果であるのか、定義をはっきりと考えることが必要になり、その過程でSUTVAが満たされているかどうかを確認することになるからである

# 3.2 確率

## 確率 {#SEC3_2_1}

統計的因果推論では、確率が重要な役割を果たす

<br/> 確率の公理主義的定義より、確率とは以下の3つの性質を満たすもののことを言う

1.  事象 $A$ の起こる確率を $Pr(A)$ と表記すると、$0 \leq Pr(A) \leq 1$である <br /> ・・・ 確率は0以上、1以下の値をとる

2.  $S$ を標本空間とすると、$Pr(S)=1$である <br /> ・・・ 標本空間に含まれる事象のどれかが起こる確率は1である

3.  事象 $A$ と $B$ は相互に排反な事象（mutually exclusive events）とすると、$Pr(A \cup B)=Pr(A)+Pr(B)$ である <br /> ・・・ 相互に排反な2つの事象の和の確率は、それぞれの事象の確率の和である

------------------------------------------------------------------------

<u>例：トランプカードからエースを引く確率</u>

$A$ ：52枚のトランプカードからエースを引く事象

ここではジョーカーを含めないものとし、52枚のカードは十分にシャッフルされている状態を想定する

52枚のカードから無作為に1枚引くことを考える

<center>

![図3.1](./img/Pic_3_1.png)

図3.1

</center>

図3.1のとおり、52枚のトランプカードの中にエースは全部で4枚あるため、エースのうち、どれかを引く確率は以下となる

$$Pr(A) = 4/52 = 1/13$$

# 3.3 条件付き確率と独立性

## 条件付き確率と独立性 {#SEC3_3_1}

2章で見たとおり、処置を無作為に割付けることで、平均処置効果（ATE）を不偏推定できるが、

それは、潜在的結果変数と処置の割付けが独立であるから可能となっていた

<br /> ここで、**独立**の意味を改めて確認する

------------------------------------------------------------------------

## 条件付き確率

<u>例: トランプカードからエースを引く条件付き確率１</u>

$B$ ：52枚のトランプカードから絵札（ジャック、クイーン、キング）を引く事象

<br /> 52枚のカードから無作為に１枚を引いたとき、その結果を開示しないとする

このとき、引いたカードがエースである確率は先ほどと同じ1/13と考えられる

<br /> さらに、「引いたカードは絵札である」という情報を開示したとしよう

すると、引いたカードがエースである確率は、$Pr(A|B)$ とあらわされる

**条件付き確率（conditional probability）**である

------------------------------------------------------------------------

条件付き確率とは、**事象** $B$ が起こったとき、事象 $A$ が起こる確率である。

図3.2のとおり、12枚の絵札の中にエースは含まれていない

<center>

![図3.2](./img/Pic_3_2.png)

図3.2

</center>

<br /> よって、引かれたカードが絵札であるとき、そのカードがエースである確率は以下となる

$$Pr(A|B)=0$$

<br /> このとき、事象 $A$ と事象 $B$ を**相互に排反な事象**という

------------------------------------------------------------------------

<u>例: トランプカードからエースを引く条件付き確率２</u>

$C$ ：52枚のトランプカードからダイヤを引く事象

先ほどと同様に、52枚のカードから無作為に1枚引いたとき、その結果を開示しないとする

そして、「引いたカードはダイヤである」という情報を開示したとする

すると、引いたカードがエースエースである確率は、$Pr(A|C)$ と表される

**条件付き確率**である

------------------------------------------------------------------------

図3.3のとおり、ダイヤは全部で13枚ある

<center>

![図3.3](./img/Pic_3_3.png)

図3.3

</center>

すでにこの13枚だけが候補となっており、この中にエースは1枚だけ含まれている

よって、引かれたカードがダイヤであるとき、そのカードがエースである確率は、

$Pr(A|C)=1/13$である

<br /> ここで、3.2節の結果より、$Pr(A)=1/13$ だった

そして、ここで見た通り、$Pr(A|C)=1/13$ である

このように、$Pr(A|C)=Pr(A)$ のとき、事象 $A$ と事象 $C$ を**独立な事象**という

------------------------------------------------------------------------

### 相互に排反な事象

事象 $A$ と事象 $B$ が**相互に排反**とは、式（3.1）が成り立つことを言う

$$Pr(A|B)=0 \tag{3.1}$$

すなわち、相互に排反とは、

**事象** $B$ が与えられたときの事象 $A$ の起こる確率が0である

ことを意味する

<br /> 52枚のトランプカードから1枚を無作為に引くとき、エースを引く確率は1/13であったが、引いたカードが絵札と分かった時点で、このカードがエースである確率は0に更新された

すなわち、相互に排反な事象とは、$A$ と $B$ が「無関係」なのではなく、むしろ、

$B$ が起こったならば、$A$ は起こらないという強い関係がある

と理解できる

------------------------------------------------------------------------

### 独立な事象

事象 $A$ と事象 $C$ が**独立**とは、式（3.2）が成り立つことを言う

$$Pr(A|C)=Pr(A) \tag{3.2}$$

<br /> すなわち、独立とは、

**事象** $C$ が与えられたときの事象 $A$の起こる確率は、事象Aだけの確率に一致する

ことを意味する

<br /> 52枚のトランプカードから1枚を無作為に引くとき、エースを引く確率は1/13だったが、

引いたカードがダイヤと分かったとしても、このカードがエースである確率は

1/13のままだった

<br /> これは、事象 $C$ には、事象 $A$ が起こることを予測する情報がなにも含まれていないことを意味している

<br /> すなわち、**事象** $A$ と事象 $C$ は「無関係」ということである

記号では、事象 $A$ と 事象 $C$ の独立を $A \perp C$と書き、$A$ と $C$ が直行していることを表している

# 3.4 条件付き期待値

## 条件付き期待値 {#SEC3_4_1}

統計的因果推論では、3.3節で確認した条件付き確率の考え方を期待値に応用する

<br /> 確率変数 $Y$ の期待値は $E[Y]$ と表し、

確率変数 $X$ が起こった場合の $Y$ の条件付き期待値（conditional expectation）は、

$E[Y|X]$で表される

<br /> $X$ と $Y$ が離散確率変数のとき、式（3.3）のとおりであり、

$X$ と $Y$ が連続確率変数のとき、式（3.4）である（Ross, 2006, p.365）

これらは、条件付き確率の重み付き平均である

$$E[Y|X]=\sum_{y}yPr(Y=y|X=x) \tag{3.3}$$

$$E[Y|X]=\int^{\infty}_{y}yf_{Y|X}(y|x)dy \tag{3.4}$$

------------------------------------------------------------------------

そして、$X$ と $Y$ が独立であれば、ここまでの確率の議論と同様に、

式（3.3）において

$$Pr(Y=y|X=x)=Pr(Y=y)$$

であるから、

$$E[Y|X]=E[Y]$$

である

<br /> つまり、$X$ と $Y$ が独立であれば、$X$ を与えたときの $Y$ の条件付き期待値 $E[Y|X]$ が、

$Y$ だけの期待値 $E[Y]$ に一致する

<br /> ここが重要なポイントである

# 3.5 識別性の条件

## 識別性の条件 {#SEC3_5_1}

統計的因果推論では、平均処置効果（ATE）または処置群の平均処置効果（ATT）のどちらかを推定対象として分析することが多い

しかし、これらは観測データをそのまま分析したのではうまく推定できない

<br /> 観測されたデータから母数（parameter）が一意に推定できることを**識別性（identifiability）**という（岩崎, 2015, p.83）

つまり、

**識別性の条件が満たされない場合、標本から母集団への推定ができない**

ということである

<br /> 特に、ここでは、

**識別性＝正値性＋独立性**

である（岩崎, 2015, pp.80-84）

なお、3.1節で導入したSUTVAは満たされていると仮定する

------------------------------------------------------------------------

## 正値性

1つ目の条件は、**割付の確率の正値性（positivity）**と言い、式（3.5）で表される

$$0<Pr(T=1)<1 \tag{3.5}$$

処置に割付られる確率 $Pr(T=1)$ が、0よりも大きく、1よりも小さいということである

ここで注意するべきことは、確率の公理主義的定義より、確率は

$$0 \leq Pr(A) \leq 1$$

と定義されていたが、正値性の条件より、$Pr(T=1)$ は0と1を含んでいない点である

<br /> つまり、正値性の条件とは、

**処置に割付けられる確率が0または1であってはならない**

ということであり、これはすべての個体が両方の処置を受ける可能性があることを意味する（阿部・岩崎訳, 2021, p.113）

------------------------------------------------------------------------

## 独立性

2つ目の条件は、**割付けの独立性**と言い、式（3.6）で表される

$$\{Y(1), Y(1)\}\perp T \tag{3.6}$$

潜在的結果変数 $\{Y(0), Y(1)\}$ と処置の割り付け $T$ が独立である

<br /> つまり、

**処置の割付けが、潜在的結果変数に依存して行われてはいけない**

ということである

<br /> なお、第2章で見たように処置の割付けが無作為なら、すべての変量と独立になっているはずであるから、実験研究では、この条件が容易に満たされているとみなすことができる

# 3.6 実験研究における平均処置効果（ATE）の推定

## 実験研究における平均処置効果（ATE）の推定 {#SEC3_6_1}

2.2節で見たとおり、観測値 $Y_{i}$は、式（3.7）のとおりに表現される

$$Y_{i}=(1-T_{i})Y_{i}(0)+T_{i}Y_{i}(1) \tag{3.7}$$

-   $T_{i}=0$ ：個体 $i$ が処置をされていないこと
-   $T_{i}=1$ ：個体 $i$ が処置をされていること
-   $Y_{i}(0)$ 　：処置のない場合の潜在的な結果
-   $Y_{i}(1)$ 　：処置のある場合の潜在的な結果

<br />

平均処置効果（ATE）は、式（3.8）のとおり定義された

$$\tau_{ATE}=E[Y_{i}(1)-Y_{i}(0)]=E[Y_{i}(1)]-E[Y_{i}(0)] \tag{3.8}$$

<br /> ここで、$Y_{i}(0)$ と $Y_{i}(1)$ は、潜在的結果変数の組を表すため、個体 $i$ に対して、どちらかが観測されるとき、もう一方が観測されないため、このままでは観測も推定もできなかった

<br /> $E[Y_{i}(1)]$ は、すべての個体が処置を受けた場合の期待値であり、$E[Y_{i}(0)]$ はすべての個体が処置を受けなかった場合の期待値を表しているのだから、**同時に観測するのは明らかに不可能**である

------------------------------------------------------------------------

2.2節では、$T_{i}=0$ のときの $Y_{i}$の値は $Y_{i}|T_{i}=0$ と表記され、$T_{i}=1$ のときの $Y_{i}$ の値は $Y_{i}|T_{i}=1$と表記されると述べた

$E[Y_{i}|T_{i}=1]$ は処置群における結果変数の期待値であり、$E[Y_{i}|T_{i}=0]$ 統制群における結果変数の期待値であるから、これは観測することができる

したがって、式（3.9）は推定することができる

$$E[Y_{i}|T_{i}=1]-E[Y_{i}|T_{i}=0] \tag{3.9}$$

<br /> しかしながら、表2.2の例では、平均処置効果（ATE）を適切に推定できていなかった

表2.2では、処置の割り付けを表す $T_{i}$ が**入学試験の点数に依存していたから**である

<br /> つまり、処置の割り付け変数が入学試験の点数と独立ではなく、

**入学試験の点数が潜在的結果変数と関連がある**

ことから、処置の割り付け変数と潜在的結果変数が独立でなかったため、

平均処置効果（ATE）を適切に推定できていなかったということである

------------------------------------------------------------------------

ここで、式（3.10）と（3.11）が成り立つことに注意する

$$E[Y_{i}|T_{i}=1]=E[Y_{i}(1)|T_{i}=1] \tag{3.10}$$

$$E[Y_{i}|T_{i}=0]=E[Y_{i}(0)|T_{i}=0] \tag{3.11}$$

$Y_{i}(1)$ は、潜在的結果変数であるが、その一部分については観測されている

$T_{i}=1$ のときの $Y_{i}(1)$ は、$T_{i}=1$ のときの $Y_{i}$ である

同様に、$Y_{i}(0)$も潜在的結果変数であるが、その一部分については観測されている

$T_{i}=0$ のときの $Y_{i}(0)$ は、$T_{i}=1$ のときの $Y_{i}$ である

よって、これらはすべて観測可能である

<br /> 具体的には、表2.1と表2.2を見てほしい

処置が1のときの期末試験の点数は、処置が1のときの潜在的結果1の点数である

処置が0のときの期末試験の点数は、処置が0のときの潜在的結果0の点数である

------------------------------------------------------------------------

処置の割付けを表す $T_{i}$ が潜在的結果変数の組 $\{Y_{i}(1),Y_{i}(0)\}$ に依存していなければ、

$T_{i}$ と $\{Y_{i}(1),Y_{i}(0)\}$ は独立である

<br /> 無作為割付けの場合、処置の割り付けを表す $T_{i}$ は個体 $i$ の属性とは無関係であるから、

$T_{i}$ は $\{Y_{i}(1),Y_{i}(0)\}$ とも無関係となる（岩崎, 2015, pp.82-83）

<br /> よって、**無作為割付の場合、独立性の条件が満たされる**ことから、3.4節の議論より

$E[Y|X]=E[Y]$であるので、式（3.12）と式（3.13）が成り立つ

$$E[Y_{i}|T_{i}=1]=E[Y_{i}(1)|T_{i}=1]=E[Y_{i}(1)] \tag{3.12}$$

$$E[Y_{i}|T_{i}=0]=E[Y_{i}(0)|T_{i}=0]=E[Y_{i}(0)] \tag{3.13}$$

<br /> したがって、無作為割付の場合、式（3.14）が成り立つことになり、

観測量である $E[Y_{i}|T_{i}=1]$ と $E[Y_{i}|T_{i}=0]$ のみから

平均処置効果（ATE）である $E[Y_{i}(1)]-E[Y_{i}(0)]$ を適切に推定できるのである

$$E[Y_{i}|T_{i}=1] - E[Y_{i}|T_{i}=0] = E[Y_{i}(1)] - E[Y_{i}(0)] \tag{3.14}$$

# 3.7 独立性と条件付き独立性：シンプソンのパラドックス

## 独立性と条件付き独立性：シンプソンのパラドックス {#SEC3_7_1}

$Pr(A|C)=Pr(A)$ のとき、事象 $A$ と事象 $C$ は独立な事象であり、

$A\perp C$ と書くと述べた

<br /> 式（3.15）のとおり、この条件の部分に $C$ だけでなく、$B$ も追加してみよう

$B$ と $C$ を条件としたとき $A$ の確率が、$C$ だけを条件としたときの $A$ の確率に一致すること

を**条件付き独立**といい、記号では $A\perp B|C$ と書く

$$Pr(A|B,C)=Pr(A|C) \tag{3.15}$$

<br /> ここで注意すべきことは、「独立ならば条件付き独立である」とは限らず、また、

「条件付き独立ならば独立である」とは限らない点である（岩崎, 2015, p.192）

<br /> このことを示す例として、**シンプソンのパラドックス**が有名である

------------------------------------------------------------------------

## シンプソンのパラドックス

表3.1のシンプソンのパラドックスは、独立 $(Y\perp T)$ でないが、条件付き独立 $(Y\perp T|X)$ の例である

<br /> 表3.1a　被験者全体に対する処置効果

| 　全体 | 　効果あり | 　効果なし | 　　計　 | 　有効割合 |
|:------:|-----------:|-----------:|---------:|-----------:|
| 処置群 |        156 |        124 |      280 |      0.557 |
| 統制群 |        107 |        183 |      290 |      0.369 |
|   計   |        263 |        307 |      570 |      0.461 |

表3.1b　男性被験者に対する処置効果

| 　全体 | 　効果あり | 　効果なし | 　　計　 | 　有効割合 |
|:------:|-----------:|-----------:|---------:|-----------:|
| 処置群 |        126 |         54 |      180 |      0.700 |
| 統制群 |         35 |         15 |       50 |      0.700 |
|   計   |        263 |         69 |      230 |      0.700 |

表3.1c　女性被験者に対する処置効果

| 　全体 | 　効果あり | 　効果なし | 　　計　 | 　有効割合 |
|:------:|-----------:|-----------:|---------:|-----------:|
| 処置群 |         30 |         70 |      100 |      0.300 |
| 統制群 |         72 |        168 |      240 |      0.300 |
|   計   |        102 |        238 |      340 |      0.300 |

------------------------------------------------------------------------

表3.1aを見ると、570人の被験者全体では

-   処置群における有効割合：0.557
-   統制群における有効割合：0.369

となっており、処置の有無と効果には関係があるように見える

<br /> 表3.1bと表3.1cでは、被験者570人を男性230人と女性340人に分け、条件付きで処置の有無と効果を見ており、

-   男性：処置群も統制群も有効割合は0.700で同じ
-   女性：処置群も統制群も有効割合は0.300で同じ

である

ゆえに、男性と女性という情報に条件付けた場合、それぞれの集団において処置の有無と効果は関係がないように見える

<br /> 統計的因果推論の立場から重要な点は、**たとえデータ全体で独立でなかったとしても、**

**共変量（covariate）に条件付けた場合には独立とみなし得る**という点である

<br /> 共変量については次節（3.8節）で解説する

# 3.8 共変量の役割

## 共変量の役割 {#SEC3_8_1}

ここまで見てきたとおり、処置の割り付けが無作為に行われる実験研究であれば、平均処置効果（ATE）を適切に推定できる

しかし、すべての研究課題について実験研究を行うことができるわけではない

<br /> 処置の割り付けを無作為にしていない研究である、観察研究において適切な統計的因果推論を行うためには、**処置群と統制群をいかにして比較可能な状態にするか**が重要である

すなわち、観察研究であっても、あたかも実験研究であるかのように比較可能な2つの集団を用意するのである

<br /> このとき、重要になるのが**共変量（covariate）**である

共変量：**結果変数** $Y_{i}$ に影響する変数の中で、処置の影響を受けていない変数 <br />（Imbens and Rubin, 2015, p.16; 岩崎, 2015, p.14）

（処置の影響を受けている変数は中間変数（mediator）といい、共変量はと区別する）

<br /> 本書では、共変量を $X$ で表す

観察研究における共変量 $X$ は多変量であることが多い点にも注意を要する

------------------------------------------------------------------------

共変量 $X$ を条件としたとき、処置の割付けを表す変数 $T_{i}$ が、潜在的結果変数の組 $\{Y_{i}(1),Y_{i}(0)\}$に依存しないことを**条件付き独立**といい、式（3.16）で表す <br /> （岩崎, 2015, p.87）

これを**無交絡性（unconfoundendness）**という（Imbens and Rubin, 2015, p.38）

$$\{Y_{i}(1),Y_{i}(0)\}\perp T_{i}|X \tag{3.16}$$

<br /> また、式（3.17）は、**条件付き正値性（conditional positivity）**である

$$0<Pr(T=1|X)<1 \tag{3.17}$$

これは、共変量 $X$ を条件とした場合に、どの個体も処置群または統制群に割付られる確率が0または1でない、つまり、どの個体も、処置群または統制群のどちらにも割付られる可能性があるということである <br /> （Imbens and Rubin, 2015, p.38; 岩崎, 2015, p.88）

<br /> 3.1節で導入したSUTVAが成り立つと仮定し、式（3.16）および式（3.17）が成り立つことを、

**強い意味での無視可能な割付け（strongly ignorable treatment assignment）**という <br /> （Imbens and Rubin, 2015, pp.38-39; 岩崎, 2015, p.88）

この条件は、計量経済学や計量政治学では、観測値による選択（selection on observables）、 あるいは、除外変数による偏り（omitted variable bias）がないこととして知られる <br /> （Ho et al., 2007, p.206; 星野, 2009, p.155; 浅野・矢内; 2013, p.240）

------------------------------------------------------------------------

式（3.15）で確認したとおり、条件付き独立とは $Pr(A|B,C)=Pr(A|C)$ を意味していた

これを期待値に応用すると、条件付き独立が成り立つとは、$E[A|B,C]=E[A|C]$ である

<br /> したがって、式（3.18）、式（3.19）、式（3.20）が成り立つ（岩崎, 2015, p.88）

$$E[Y_{i}|T_{i}=1,X]=E[Y_{i}(1)|T_{i}=1,X]=E[Y_{i}(1)|X] \tag{3.18}$$

$$E[Y_{i}|T_{i}=0,X]=E[Y_{i}(0)|T_{i}=0,X]=E[Y_{i}(0)|X] \tag{3.19}$$

$$E[Y_{i}|T_{i}=1,X]-E[Y_{i}|T_{i}=0,X]=E[Y_{i}(1)|X]-E[Y_{i}(0)|X] \tag{3.20}$$

------------------------------------------------------------------------

表3.2を使って具体的に考察する

<br /> 表3.2 数学の試験（無視可能な割り付け）

| ID  | 　入学試験 | 　期末試験 | 処置 |        割付け確率         |
|:---:|:----------:|:----------:|:----:|:-------------------------:|
|  1  |     70     |     74     |  1   | 確率4/5で無作為に割り付け |
|  2  |     70     |     63     |  0   |                           |
|  3  |     70     |     73     |  1   |                           |
|  4  |     70     |     71     |  1   |                           |
|  5  |     70     |     74     |  1   |                           |
|  6  |     75     |     67     |  0   | 確率3/5で無作為に割り付け |
|  7  |     75     |     77     |  1   |                           |
|  8  |     75     |     68     |  0   |                           |
|  9  |     75     |     77     |  1   |                           |
| 10  |     75     |     78     |  1   |                           |
| 11  |     85     |     88     |  1   | 確率2/5で無作為に割り付け |
| 12  |     85     |     77     |  0   |                           |
| 13  |     85     |     76     |  0   |                           |
| 14  |     85     |     86     |  1   |                           |
| 15  |     85     |     78     |  0   |                           |
| 16  |     90     |     81     |  0   | 確率1/5で無作為に割り付け |
| 17  |     90     |     91     |  1   |                           |
| 18  |     90     |     82     |  0   |                           |
| 19  |     90     |     82     |  0   |                           |
| 20  |     90     |     82     |  0   |                           |

------------------------------------------------------------------------

このデータでは、補習授業は強制ではなく、受けるかどうかは学生の裁量に委ねられていると想定する

入学試験の点数が低い学生ほど自信が低いため補習授業に参加する確率が高く、逆に、入学試験の点数が高い学生ほど自信が高いため補習授業に参加する確率が低いという状況設定を考える

よって、このデータでは、**入学試験の点数に依存して処置の割付けが決まっているため、データ全体では無作為な割り付けではない**

ここで、観察研究を単純化して考えるために、入学試験の点数が同じ学生の間では、補習授業を受ける確率は同じと考える

<br /> つまり、学生は補習授業を受けるか受けないかを自主的に決めるが、**その判断は入学試験の点数に依存して確率的に決まる**と考える

-   ID 1～ 5の学生：入学試験の点数が70点、補習授業を受ける確率が4/5
-   ID 6～10の学生：入学試験の点数が75点、補習授業を受ける確率が3/5
-   ID 11～15の学生：入学試験の点数が85点、補習授業を受ける確率が2/5
-   ID 16～20の学生：入学試験の点数が90点、補習授業を受ける確率が1/5

共変量である入学試験の点数が同じ同士では、処置の割付け確率が同じであることを <br /> **無視可能な割付け**という

これは、共変量に条件付けたとき、局所的に無作為割付けが実現されているということである

------------------------------------------------------------------------

表3.3のとおり、data03を読み込んで分析する

表3.3 データの読み込み

```{r}
rm(list = ls())
data03 <- read.csv("./causality-main/data03.csv")
attach(data03)
summary(data03)
```

-   変数x1：入学試験の点数
-   変数y3：観測された期末試験の点数
-   変数t1：処置の割付けを表す変数
-   変数 y0t と y1t：潜在的結果変数

------------------------------------------------------------------------

表3.4 分析表

    mean(y3[t1 == 1]) - mean(y3[t1 == 0])
    mean(y1t) - mean(y0t)

```{r echo}
mean(y3[t1 == 1]) - mean(y3[t1 == 0])
mean(y1t) - mean(y0t)
```

<br /> 1行目は処置の割付け変数t1が1の場合のy3の平均値と、処置の割り付け変数t1が0の場合のy3の平均値の差の計算であり、解は3.3である

これは、ナイーブな推定量である

<br /> 2行目では、潜在的結果変数y0tとy1tの平均値の差を計算しており、解は9.8である

これが平均処置効果（ATE）の真値である

------------------------------------------------------------------------

このように、「無視可能な割付け」とは、ナイーブな推定量によって文字通りに

「割付けを無視して解析してよい」ということを意味していない

<br /> ここは、混乱が起こりやすいところであるので、注意が必要である

<br /> どういう意味で「無視可能な割付け」と言えるのだろうかという疑問は、次節（3.9節）で解決する

# 3.9 回帰分析と共分散分析

## 3.9 回帰分析と共分散分析 {#SEC3_9_1}

共変量 $X$ を条件としたとき、処置の割付けを表す変数 $T_{i}$ が、 潜在的結果変数の組 $\{Y_{i}(1),Y_{i}(0)\}$ に依存しない無視可能な割付けの場合、 どのようにして平均処置効果（ATE）を推定できるか確認する

<br /> 引き続き、数学の試験データ（data03）を使用する

------------------------------------------------------------------------

図3.4、図3.5は、横軸に入学試験の点数を配置し、縦軸に期末試験の点数を配置した散布図である

::: col
```{r echo=FALSE}
plot(x1, y3, xlim = c(60, 100), ylim = c(60, 100), main="A. 散布図", xlab="入学試験", ylab="期末試験")
```

図3.4　A. 散布図
:::

::: col
```{r echo=FALSE}
plot(x1, y3, xlim = c(60, 100), ylim = c(60, 100), main="B. 回帰直線（全集団）", xlab="入学試験", ylab="期末試験")

m <- lm(y3~x1)
abline(m)
```

図3.4　B. 回帰直線（全集団）
:::

図3.4Aは、全集団の散布図であり、図3.4Bは、全集団に対して、最小二乗法（OLS: ordinary least squares）による回帰直線を引いたものである

図3.4Aからは正の相関関係、図3.4Bからは平均して右肩上がりの傾向がみて取れるが、

**ここではあまり重要ではない**

------------------------------------------------------------------------

なぜなら、ここでは、全集団における入学試験の期末試験に与える効果を知りたいわけではないからである

ここで知りたいことは、**補習授業の期末試験に与える効果**である

------------------------------------------------------------------------

::: col
```{r echo=FALSE}
plot(x1, y3, xlim = c(60, 100), ylim = c(60, 100), main="C. 散布図（群ごと）", xlab="入学試験", ylab="期末試験", type="n")
points(x1[t1 == 1], y3[t1 == 1], pch = 2)
points(x1[t1 == 0], y3[t1 == 0], pch = 4)
```

図3.5 C. 散布図（群ごと）
:::

::: col
```{r echo=FALSE}
plot(x1, y3, xlim = c(60, 100), ylim = c(60, 100), main="D. 回帰直線（群ごと）", xlab="入学試験", ylab="期末試験", type="n")
points(x1[t1 == 1], y3[t1 == 1], pch = 2)
points(x1[t1 == 0], y3[t1 == 0], pch = 4)

m1 <- lm(y3[t1 == 1]~x1[t1 == 1])
abline(m1)

m0 <- lm(y3[t1 == 0]~x1[t1 == 0])
abline(m0)

```

図3.5 D. 回帰直線（群ごと）
:::

図3.5Cは、群ごとにマークを変更した散布図で、

-   △：期末試験1（補習授業を受けた）
-   ×：期末試験0（補習授業を受けていない）

である

<br /> 2つの集団にきれいに分かれている様子が見てとれる

------------------------------------------------------------------------

図3.5Dは、2つの群ごとに分けて回帰直線を引いたものである

ここから、2つの回帰直線は並行に走っていることがわかる

この**2つの回帰直線の縦方向の差が、平均処置効果（ATE）**であり、この発見は重要である

<br />

このように、処置の割り付けが無視可能とは、

**共変量（ここでは入学試験）に条件付けた場合、処置群と統制群における結果変数（ここでは期末試験）の平均的な差をとれば良い**

ことを意味している

------------------------------------------------------------------------

ここまでの話をフォーマルに整理する

<br /> 式（3.21）は回帰分析（regression）であり、これは、図3.4Aを表している

$$Y_{i}=\beta _{0}+\beta _{1}X_{i}+\varepsilon _{i} \tag{3.21}$$

-   $Y_{i}$：結果変数（図3.4の期末試験）
-   $X_{i}$：共変量（図3.4の入学試験）
-   $\varepsilon _{i}$：誤差項（error term）
-   $\beta _{0}$、$\beta _{1}$ ：回帰の母数（パラメータ）

<br />

式（3.22）は回帰モデルであり、式3.4Bの直線を表している

$\hat{\beta_{1}}$ の \^ はハット記号といい、推定値を表す

$$\hat{Y}_{i}=\hat{\beta_{0}}+\hat{\beta_{1}}X_{i} \tag{3.22}$$

------------------------------------------------------------------------

式（3.23）は分散分析（ANOVA: analysis of variance）である

実際に推定するモデルは、式（3.24）である

$$Y_{i}=\beta _{0}+\beta _{2}T_{i}+\varepsilon _{i} \tag{3.23}$$

$$\hat{Y}_{i}=\hat{\beta_{0}}+\hat{\beta_{2}}T_{i} \tag{3.24}$$

<br /> これは、すべての説明変数がダミー変数のみから構成されている回帰分析の特殊版である

ダミー変数とは、処置の割付け変数 $T_{i}$ のように、0または1の二値からなる変数である

これまでと同様に、

-   $T_{i}=0$：個体 $i$ が処置をされていないこと（統制群）
-   $T_{i}=1$：個体 $i$ が処置をされていること（処置群）

を表している

------------------------------------------------------------------------

式（3.25）は共分散分析（ANCOVA:analysis of covariance）である

実際に推定するモデルは、式（3.26）である

$$Y_{i}=\beta _{0}+\beta _{1}X_{i}+\beta _{2}T_{i}+\varepsilon _{i} \tag{3.25}$$

$$\hat{Y}_{i}=\hat{\beta_{0}}+\hat{\beta_{1}}X_{i}+\hat{\beta_{2}}T_{i} \tag{3.26}$$

これは、式（3.22）と式（3.24）を合体させることで、回帰分析と分散分析の長所を併せ持つように工夫されたものである <br /> (Cochran, 1957, p.261; Bollen, 1989, pp.130-131; Gujarati, 2003, pp.304-305)

<br /> つまり、**共分散分析とは、ダミー変数を説明変数として持つ重回帰分析のこと**である

式（3.25）は図3.5Cを表しており、式（3.26）は図3.5Dを表している

------------------------------------------------------------------------

$T_{i}=0$ のとき、式（3.27）である

つまり、統制群における $Y$ 切片は、$\hat{\beta_{0}}$である

統制群では、$X_{i}$ の値が0のとき、$Y_{i}$ の値は $\hat{\beta_{0}}$ である

$$
\begin{align}
\hat{Y_{i}}&=\hat{\beta_{0}}+\hat{\beta_{1}}X_{i}+\hat{\beta_{2}}T_{i}\\
\hat{Y_{i}}&=\hat{\beta_{0}}+\hat{\beta_{1}}X_{i}
\tag{3.27}
\end{align}
$$

<br /> $T_{i}=1$のとき、式（3.28）である

つまり、処置群における $Y$ 切片は、$\hat{\beta_{0}} + \hat{\beta_{2}}$である

統制群では、$X_{i}$ の値が0のとき、$Y_{i}$ の値は $\hat{\beta_{0}} + \hat{\beta_{2}}$ である

$$
\begin{align}
\hat{Y_{i}}&=\hat{\beta_{0}}+\hat{\beta_{1}}X_{i}+\hat{\beta_{2}}T_{i}\\
\hat{Y_{i}}&=(\hat{\beta_{0}}+\hat{\beta_{2}})+\hat{\beta_{1}}X_{i}
\tag{3.28}
\end{align}
$$

<br /> したがって、$\hat{\beta_{2}}$ は、2つの集団における $Y$ 切片の変化を表している <br /> （Wooldridge, 2020, p.222）

いくつかの条件を満たさなければいけないが、$\hat{\beta_{2}}$ は平均処置効果（ATE）を捉えていると考えることができる

------------------------------------------------------------------------

表3.2のデータを共分散分析でモデリングするには、表3.5のようにすればよい

表3.5 共分散分析

    model1 <- lm(y3 ~ x1 + t1)
    summary(model1)
    confint(model1, level=0.95)

```{r echo=FALSE}
model1 <- lm(y3 ~ x1 + t1)
summary(model1)
confint(model1, level=0.95)
```

重要なポイントは、t1の回帰係数（Estimate）の値である

この値が、式（3.26）における $\hat{\beta_{2}}$ で、平均処置効果（ATE）を捉えており、9.82と推定される

また、95%信頼区間は8.91～10.72である

------------------------------------------------------------------------

表3.4の分析より、平均処置効果（ATE）の真値は9.8点だった

よって、**無視可能な割付けであれば、共変量の情報に条件付けることで、平均処置効果（ATE）を適切に推定できている**ことがわかる
